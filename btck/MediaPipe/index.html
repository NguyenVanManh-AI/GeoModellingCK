<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="main.css" />
  <title>Objects Control</title>
  <link rel="shortcut icon" href="https://threejs.org/files/favicon.ico" media="(prefers-color-scheme: light)">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
  <script src="load_obj_example/three.min.js"></script>

  <script src="load_obj_example/MTLLoader.js"></script>
  <script src="load_obj_example/OBJMTLLoader.js"></script>

  <script src="load_obj_example/OBJLoader.js"></script>
  <script src="load_obj_example/Detector.js"></script>
  <script src="load_obj_example/stats.min.js"></script>
  <script type="module">
    // import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.module.js";

    var xSpeed = 0.5;
    var topSpeed = 0.5;
    var scaleSpeed = 0.03; // Tốc độ thay đổi scale
    var movingLeft = false;
    var movingRight = false;
    var movingTop = false;
    var movingBottom = false;
    var ySpeed = 0;
    var actionRotate = 'XN'
    var targetRotation = 0;
    var rotating = false;
    var scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);
    var camera ;
    var renderer;

    var loadedObject;
    var objectSelect = 'IronMan';

    // url 
    const urlParams = new URLSearchParams(window.location.search);
    objectSelect = urlParams.get('name');
    if (!objectSelect) {
      urlParams.set('name', 'IronMan');
      const newUrl = window.location.pathname + '?' + urlParams.toString();
      window.location.href = newUrl;
    } else { console.log("Tham số location đã tồn tại: ", objectSelect); }
    // url 


    init(objectSelect);
    function init(objectSelect) {
      camera = new THREE.PerspectiveCamera(100, window.innerWidth / window.innerHeight, 1, 10000);
      camera.position.z = 150;
      camera.position.y = 100;


      // // scene
      // scene = new THREE.Scene();
      // var directionalLight = new THREE.DirectionalLight(0xffeedd);
      // directionalLight.position.set(0, 0, 1).normalize();
      // scene.add(directionalLight);
      // // texture
      // var texture = new THREE.Texture();
      // var loader = new THREE.ImageLoader();
      // loader.addEventListener('load', function (event) {
      //   texture.image = event.content;
      //   texture.needsUpdate = true;
      // });
      // loader.load('load_obj_example/ash_uvgrid01.jpg');
      // // model
      // var loader = new THREE.OBJLoader();
      // loader.addEventListener('load', function (event) {
      //   var object = event.content;
      //   loadedObject = object; // Lưu đối tượng đã load vào biến global
      //   for (var i = 0, l = object.children.length; i < l; i++) {
      //     object.children[i].material.map = texture;
      //   }
      //   scene.add(object);
      // });


      // scene
      scene = new THREE.Scene();
      var ambient = new THREE.AmbientLight( 0x101030 );
      scene.add( ambient );
      var directionalLight = new THREE.DirectionalLight( 0xffeedd );
      directionalLight.position.set( 0, 0, 1 ).normalize();
      scene.add( directionalLight );
      // model
      var loader = new THREE.OBJMTLLoader();
      loader.addEventListener( 'load', function ( event ) {
        var object = event.content;
        loadedObject = object;
        scene.add( object );
      });

      var listMTL = ["bugatti", "IronMan", "Tree1", "Room", "Cottage", "Bird", "Duck", "Aircraft"];
      if(listMTL.includes(objectSelect)) loader.load( 'obj/'+objectSelect+'.obj', 'obj/'+objectSelect+'.mtl' );
      else loader.load('obj/' + objectSelect + '.obj');
      //
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById("container-box").appendChild(renderer.domElement);
    }

    function loadObjectSelected(nameObject) {
      const urlParams = new URLSearchParams(window.location.search);
      urlParams.set('name', nameObject);
      const newUrl = window.location.pathname + '?' + urlParams.toString();
      window.location.href = newUrl;
    }
    document.getElementById('objSelect').addEventListener('change', function () {
      loadObjectSelected(this.value);
    });

    function animate() {
      requestAnimationFrame(animate);

      if (rotating) {
        if (actionRotate == 'XC') {
          loadedObject.rotation.x += ySpeed;
          if (loadedObject.rotation.x >= targetRotation) {
            rotating = false;
            ySpeed = 0;
          }
        }
        if (actionRotate == 'XN') {
          loadedObject.rotation.x -= ySpeed;
          if (loadedObject.rotation.x <= targetRotation) {
            rotating = false;
            ySpeed = 0;
          }
        }
        if (actionRotate == 'YC') {
          loadedObject.rotation.y += ySpeed;
          if (loadedObject.rotation.y >= targetRotation) {
            rotating = false;
            ySpeed = 0;
          }
        }
        if (actionRotate == 'YN') {
          loadedObject.rotation.y -= ySpeed;
          if (loadedObject.rotation.y <= targetRotation) {
            rotating = false;
            ySpeed = 0;
          }
        }
        if (actionRotate == 'ZC') {
          loadedObject.rotation.z += ySpeed;
          if (loadedObject.rotation.z >= targetRotation) {
            rotating = false;
            ySpeed = 0;
          }
        }
        if (actionRotate == 'ZN') {
          loadedObject.rotation.z -= ySpeed;
          if (loadedObject.rotation.z <= targetRotation) {
            rotating = false;
            ySpeed = 0;
          }
        }
      }
      if (movingLeft) {
        loadedObject.position.x -= xSpeed;
      } else if (movingRight) {
        loadedObject.position.x += xSpeed;
      }

      if (movingBottom) {
        loadedObject.position.y -= topSpeed;
      } else if (movingTop) {
        loadedObject.position.y += topSpeed;
      }

      renderer.render(scene, camera);
    }
    animate();

    function moveLeft() {
      movingLeft = true;
      setTimeout(function () {
        movingLeft = false;
      }, 1000); // 1s
    }

    function moveRight() {
      movingRight = true;
      setTimeout(function () {
        movingRight = false;
      }, 1000); // 1s
    }

    document.getElementById("moveLeftButton").addEventListener("click", moveLeft);
    document.getElementById("moveRightButton").addEventListener("click", moveRight);

    function moveTop() {
      movingTop = true;
      setTimeout(function () {
        movingTop = false;
      }, 1000); // 1s
    }

    function moveBottom() {
      movingBottom = true;
      setTimeout(function () {
        movingBottom = false;
      }, 1000); // 1s
    }

    document.getElementById("moveTopButton").addEventListener("click", moveTop);
    document.getElementById("moveBottomButton").addEventListener("click", moveBottom);


    function rotateXC() {
      actionRotate = 'XC';
      rotating = true;
      targetRotation += Math.PI / 6;
      ySpeed = Math.PI / 180;
    }

    function rotateXN() {
      actionRotate = 'XN';
      rotating = true;
      targetRotation -= Math.PI / 6;
      ySpeed = Math.PI / 180;
    }

    function rotateYC() {
      actionRotate = 'YC';
      rotating = true;
      targetRotation += Math.PI / 6;
      ySpeed = Math.PI / 180;
    }


    function rotateYN() {
      actionRotate = 'YN';
      rotating = true;
      targetRotation -= Math.PI / 6;
      ySpeed = Math.PI / 180;
    }



    function rotateZC() {
      actionRotate = 'ZC';
      rotating = true;
      targetRotation += Math.PI / 6;
      ySpeed = Math.PI / 180;
    }



    function rotateZN() {
      actionRotate = 'ZN';
      rotating = true;
      targetRotation -= Math.PI / 6;
      ySpeed = Math.PI / 180;
    }


    document.getElementById("rotateXCButton").addEventListener("click", rotateXC);

    document.getElementById("rotateXNButton").addEventListener("click", rotateXN);

    document.getElementById("rotateYCButton").addEventListener("click", rotateYC);

    document.getElementById("rotateYNButton").addEventListener("click", rotateYN);

    document.getElementById("rotateZCButton").addEventListener("click", rotateZC);

    document.getElementById("rotateZNButton").addEventListener("click", rotateZN);

    // zoomIn and zoomOut
    var zoomAmount = 0.6; // Lượng zoom mỗi lần click
    function zoomIn() {
      var currentScale = loadedObject.scale.x;
      var targetScale = currentScale - zoomAmount;
      animateScale(loadedObject, currentScale, targetScale);
    }
    function zoomOut() {
      var currentScale = loadedObject.scale.x;
      var targetScale = currentScale + zoomAmount;
      animateScale(loadedObject, currentScale, targetScale);
    }
    document.getElementById("zoomInButton").addEventListener("click", zoomIn);
    document.getElementById("zoomOutButton").addEventListener("click", zoomOut);

    function animateScale(object, currentScale, targetScale) {
      var animateScaleInternal = function () {
        if ((currentScale < targetScale && object.scale.x < targetScale) ||
          (currentScale > targetScale && object.scale.x > targetScale)) {
          object.scale.x += (targetScale - currentScale) * scaleSpeed;
          object.scale.y += (targetScale - currentScale) * scaleSpeed;
          object.scale.z += (targetScale - currentScale) * scaleSpeed;
          requestAnimationFrame(animateScaleInternal);
        }
      };

      animateScaleInternal();
    }
    // zoomIn and zoomOut

    // moveFar
    var moveAmount = 50; // Lượng di chuyển mỗi lần click

    function moveFar() {
      var currentZ = loadedObject.position.z;
      var targetZ = currentZ - moveAmount;
      animatePosition(loadedObject, currentZ, targetZ);
    }

    function moveNear() {
      var currentZ = loadedObject.position.z;
      var targetZ = currentZ + moveAmount;
      animatePosition(loadedObject, currentZ, targetZ);
    }


    document.getElementById("moveFarButton").addEventListener("click", moveFar);
    document.getElementById("moveNearButton").addEventListener("click", moveNear);

    function animatePosition(object, currentZ, targetZ) {
      var moveSpeed = 5; // Tốc độ di chuyển
      var moveDiff = targetZ - currentZ;

      var animatePositionInternal = function () {
        if ((currentZ < targetZ && object.position.z < targetZ) ||
          (currentZ > targetZ && object.position.z > targetZ)) {
          object.position.z += moveDiff * moveSpeed;
          requestAnimationFrame(animatePositionInternal);
        }
      };

      animatePositionInternal();
    }
    // moveFar

    // socket
    const socket = new WebSocket('ws://localhost:8765');

    socket.addEventListener('message', function (event) {
      document.getElementById('name_action_detect').value  = event.data;
      console.log(event.data);
      switch (event.data) {
        case 'moveLeft':
          moveLeft();
          break;
        case 'moveRight':
          moveRight();
          break;
        case 'moveTop':
          moveTop();
          break;
        case 'moveBottom':
          moveBottom();
          break;
        case 'rotateXC':
          rotateXC();
          break;
        case 'rotateXN':
          rotateXN();
          break;
        case 'rotateYC':
          rotateYC();
          break;
        case 'rotateYN':
          rotateYN();
          break;
        case 'rotateZC':
          rotateZC();
          break;
        case 'rotateZN':
          rotateZN();
          break;

        case 'zoomOut':
          zoomOut();
          break;

        case 'zoomIn':
          zoomIn();
          break;

        case 'moveFar':
          moveFar();
          break;
        case 'moveNear':
          moveNear();
          break;
        default:
          // Xử lý giá trị không khớp nếu cần
          break;
      }
    });

  </script>
  <section id="demos">
    <div id="container-box"></div>
    <div id="list_btn" class="d-flex justify-content-end">
      <div>
        <button type="button" class="m-1 btn btn-outline-primary" id="moveLeftButton"><i class="fa-solid fa-angles-left"></i> Move Left</button>
        <button type="button" class="m-1 btn btn-outline-primary" id="moveRightButton"><i class="fa-solid fa-angles-right"></i> Move Right</button>
        <button type="button" class="m-1 btn btn-outline-primary" id="moveTopButton"><i class="fa-solid fa-angles-up"></i> Move Top</button>
        <button type="button" class="m-1 btn btn-outline-primary" id="moveBottomButton"><i class="fa-solid fa-angles-down"></i> Move Bottom</button>
        <button type="button" class="m-1 btn btn-outline-info" id="zoomInButton"><i class="fa-solid fa-minimize"></i> Zoom In</button>
        <button type="button" class="m-1 btn btn-outline-info" id="zoomOutButton"><i class="fa-solid fa-arrows-up-down-left-right"></i> Zoom Out</button>
        <button type="button" class="m-1 btn btn-outline-success" id="rotateXCButton">Rotate XC</button>
        <button type="button" class="m-1 btn btn-outline-success" id="rotateXNButton">Rotate XN</button>
        <button type="button" class="m-1 btn btn-outline-success" id="rotateYCButton">Rotate YC</button>
        <button type="button" class="m-1 btn btn-outline-success" id="rotateYNButton">Rotate YN</button>
        <button type="button" class="m-1 btn btn-outline-success" id="rotateZCButton">Rotate ZC</button>
        <button type="button" class="m-1 btn btn-outline-success" id="rotateZNButton">Rotate ZN</button>
        <button type="button" class="m-1 btn btn-outline-warning" id="moveFarButton">Move Far</button>
        <button type="button" class="m-1 btn btn-outline-warning" id="moveNearButton">Move Near</button>
      </div>
    </div>
    <div id="group-div" class="col-12">
      <div class="row p-2 d-flex justify-content-end">
        <div class="col-2">
          <select id="objSelect" class="form-select" aria-label="Default select example">
            <option selected value="male">Select Object</option>
            <option value="male">Male</option>
            <option value="turtle">Turtle</option>
            <option value="bugatti">Bugatti</option>
            <option value="IronMan">IronMan</option>
            <option value="Tree1">Tree1</option>
            <option value="Room">Room</option>
            <option value="Cottage">Cottage</option>
            <option value="Bird">Bird</option>
            <option value="Duck">Duck</option>
            <option value="Aircraft">Aircraft</option>
          </select>
        </div>
        <div class="col-2">
          <input id="name_action_detect" class="form-control col-2" placeholder="Name Action">
        </div>
      </div>
    </div>
  </section>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>